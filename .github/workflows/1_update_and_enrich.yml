name: Store Sync

on:
  workflow_dispatch:
  issues:
    types: [opened, reopened]
  schedule:
    - cron: '0 0 * * *'

jobs:
  process-updates:
    runs-on: ubuntu-latest
    if: contains(github.event.issue.labels.*.name, 'stored-object')
    permissions:
      issues: write
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
          
      - name: Install dependencies
        run: pip install gh-store arxiv
          
      - name: Process Updates
        run: |
          python -m gh_store process-updates \
            --issue ${{ github.event.issue.number }} \
            --token ${{ secrets.GITHUB_TOKEN }} \
            --repo ${{ github.repository }}

      - name: Hydrate Metadata (arXiv papers)
        if: contains(github.event.issue.labels.*.name, 'stored-object')
        run: |
          # Try to hydrate metadata, but don't fail if it doesn't work
          python papers-feed/scripts/hydrate_metadata.py hydrate_issue_metadata \
            --issue ${{ github.event.issue.number }} \
            --token ${{ secrets.GITHUB_TOKEN }} \
            --repo ${{ github.repository }} || echo "Metadata hydration failed or not applicable (this is OK for non-arXiv papers)"

      - name: Close issue after processing (to reduce notifications)
        if: contains(github.event.issue.labels.*.name, 'stored-object')
        uses: actions/github-script@v7
        with:
          script: |
            // Close the issue to reduce email notifications
            // The issue data is already stored, so we don't need it open
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              state: 'closed'
            });
            console.log(`Closed issue #${context.payload.issue.number} to reduce notifications`);

  notify-deploy:
    needs: process-updates
    runs-on: ubuntu-latest
    steps:
      - name: Trigger frontend deploy
        run: |
          curl -L \
            -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/${{ github.repository }}/actions/workflows/2_deploy-frontend.yml/dispatches \
            -d "{\"ref\":\"${{ github.ref }}\"}"
